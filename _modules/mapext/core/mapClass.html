<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>mapext.core.mapClass &mdash; MAPEXT 2024.0.15 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=56105f59"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            MAPEXT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">mapext</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">MAPEXT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">mapext.core.mapClass</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for mapext.core.mapClass</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.units</span> <span class="kn">import</span> <span class="n">Quantity</span><span class="p">,</span> <span class="n">Unit</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">convolve</span><span class="p">,</span> <span class="n">Gaussian2DKernel</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.wcs.utils</span> <span class="kn">import</span> <span class="n">pixel_to_skycoord</span>
<span class="kn">from</span> <span class="nn">astropy_healpix</span> <span class="kn">import</span> <span class="n">HEALPix</span>
<span class="kn">from</span> <span class="nn">reproject</span> <span class="kn">import</span> <span class="n">reproject_interp</span><span class="p">,</span><span class="n">reproject_from_healpix</span>
<span class="kn">from</span> <span class="nn">mapext</span> <span class="kn">import</span> <span class="n">_version</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;astroMap&#39;</span><span class="p">,</span> <span class="s1">&#39;mapObj&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_astropy_quantity</span><span class="p">(</span><span class="n">quantity_string</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantity_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Quantity</span><span class="p">(</span><span class="n">quantity_string</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantity_string</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">quantity_string</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot convert input to astropy Quantity object.&#39;</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">get_astropy_unit</span><span class="p">(</span><span class="n">unit_string</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit_string</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Unit</span><span class="p">(</span><span class="n">unit_string</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit_string</span><span class="p">,</span> <span class="n">Unit</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unit_string</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot convert input to astropy Unit object.&#39;</span><span class="p">)</span>

<span class="n">coorddict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;g&#39;</span> <span class="p">:</span> <span class="s1">&#39;galactic&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="astroMap">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.astroMap">[docs]</a>
<span class="k">class</span> <span class="nc">astroMap</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to hold one or many astronomical maps alongside metadata describing them. Each map held inside an `astroMap` object is contained in a `mapObj` object inside the `astroMap` instance.</span>
<span class="sd">    </span>
<span class="sd">    Metadata is split into overarching/common metadata (such as origin, reference, frequency) which is held in the `astroMap`, and map-specific metadata (such as Stokes component, projection and resolution) which is held in the `mapObj`.</span>
<span class="sd">    </span>
<span class="sd">    :param load_maps: Stokes parameters of maps to preload from supplied map details. Defaults to &#39;IQU&#39;.</span>
<span class="sd">    :type load_maps: str, kwarg, optional</span>
<span class="sd">    :param Metadata: Dictionary containing general metadata about the maps to be initialised. Must contain `name` and `freq` keys.</span>
<span class="sd">    :type Metadata: dict, kwarg    </span>
<span class="sd">    :param I: Dictionary containing metadata for the Stokes I map to be initialised. Must contain `fname`, `unit` and `resolution` keys, can contain `header`, `tfield` and `temp` keys. All keys are passed onto a `mapObj` instance without interpretation.</span>
<span class="sd">    :type I: dict, kwarg, optional    </span>
<span class="sd">    :param Q: Dictionary containing metadata for the Stokes Q map to be initialised. Must contain `fname`, `unit` and `resolution` keys, can contain `header`, `tfield` and `temp` keys. All keys are passed onto a `mapObj` instance without interpretation.</span>
<span class="sd">    :type Q: dict, kwarg, optional</span>
<span class="sd">    :param U: Dictionary containing metadata for the Stokes U map to be initialised. Must contain `fname`, `unit` and `resolution` keys, can contain `header`, `tfield` and `temp` keys. All keys are passed onto a `mapObj` instance without interpretation.</span>
<span class="sd">    :type U: dict, kwarg, optional</span>
<span class="sd">    </span>
<span class="sd">    :raises ValueError: Key `freq` must be specified in Metadata kwarg dictionary.</span>
<span class="sd">    </span>
<span class="sd">    :warnings: All functions are defined for cartesian map projections, but may not be for native HEALPix map operation. Please check that your maps are suitable to be processed in cartesian before reprojecting for compatibility.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_maps</span><span class="o">=</span><span class="s1">&#39;IQU&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialise astroMap object with parameters given in keyword arguments. Map objects are initialised into mapObj objects inside this class ready for processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># INITIALISE MAP METADATA</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;Metadata&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;mapobject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">get_astropy_quantity</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Key `freq` must be specified in Metadata kwarg dictionary.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">load_maps</span><span class="p">)</span>

        <span class="c1"># run through IQU maps</span>
        <span class="k">for</span> <span class="n">stokes_parameter</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">]:</span>
            <span class="n">map_params</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stokes_parameter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">map_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">stokes_parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">load_maps</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stokes_parameter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stokes_parameter</span><span class="p">,</span> <span class="n">mapObj</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ID</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">stokes_parameter</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="o">**</span><span class="n">map_params</span><span class="p">))</span>
        <span class="k">return</span>
    
<div class="viewcode-block" id="astroMap.set_map_projection">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.astroMap.set_map_projection">[docs]</a>
    <span class="k">def</span> <span class="nf">set_map_projection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to set map projection for all available maps in this object. For details see :func:`mapext.core.mapClass.mapObj.reproject`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">comp_stokes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes</span><span class="p">:</span>
            <span class="n">comp_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_stokes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp_obj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">comp_obj</span><span class="o">.</span><span class="n">reproject</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="astroMap.set_map_resolution">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.astroMap.set_map_resolution">[docs]</a>
    <span class="k">def</span> <span class="nf">set_map_resolution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to set map resolution for all available maps in this object. For details see :func:`mapext.core.mapClass.mapObj.smooth_to`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">comp_stokes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes</span><span class="p">:</span>
            <span class="n">comp_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_stokes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp_obj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">comp_obj</span><span class="o">.</span><span class="n">smooth_to</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="astroMap.set_map_units">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.astroMap.set_map_units">[docs]</a>
    <span class="k">def</span> <span class="nf">set_map_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to set map units for all available maps in this object. For details see :func:`mapext.core.mapClass.mapObj.convert_units`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">comp_stokes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes</span><span class="p">:</span>
            <span class="n">comp_obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_stokes</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comp_obj</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">comp_obj</span><span class="o">.</span><span class="n">smooth_to</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span></div>
</div>



<div class="viewcode-block" id="mapObj">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj">[docs]</a>
<span class="k">class</span> <span class="nc">mapObj</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to hold a single astronomical map as part of an astroMap object. Holds map-specific metadata that can change between Stokes parameter maps from teh same source. </span>
<span class="sd">    </span>
<span class="sd">    :param name: Map name. If initialised as part of `astroMap` object, will be set to `{astromapName}_{stokesParameter}`.</span>
<span class="sd">    :type name: string, kwarg</span>
<span class="sd">    :param freq: Map central frequency.</span>
<span class="sd">    :type freq: string or astropy.units.Quantity, kwarg</span>
<span class="sd">    :param fname: Filename for data to be read from.</span>
<span class="sd">    :type fname: str, kwarg</span>
<span class="sd">    :param resolution: Resolution of the map as read in.</span>
<span class="sd">    :type resolution: str, kwarg</span>
<span class="sd">    :param beamwidth: Beamwidth of original telescope beam before any postprocessing or smoothing. Defaults to resolution value.</span>
<span class="sd">    :type beamwidth: string or astropy.units.Quantity, kwarg, optional</span>
<span class="sd">    :param cal: Calibration uncertainty as percentage (e.g. 5% should be inputted at 5). Defaults to 8%.</span>
<span class="sd">    :type cal: float, kwarg, optional</span>
<span class="sd">    :param unit: Units of teh input map. If units are Kelvin (K), use temp keyword to specify temperature type.</span>
<span class="sd">    :type unit: string or astropy.units.Unit, kwarg, optional</span>
<span class="sd">    :param temp: Type of temperature specified in units: `cmb` for CMB temperature (as defined by Planck) or `rj` for Rayleigh-Jeans temperature.</span>
<span class="sd">    :type temp: str, kwarg, optional</span>
<span class="sd">    :param zaxis: index of map to read in if specified in an image cube 9greater than 2 dimensions).</span>
<span class="sd">    :type zaxis: int, kwarg, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialises mapObj object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">get_astropy_quantity</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reso</span> <span class="o">=</span> <span class="n">get_astropy_quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bwid</span> <span class="o">=</span> <span class="n">get_astropy_quantity</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beamwidth&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">get_astropy_unit</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mK</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">uK</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">nK</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">,</span> <span class="s1">&#39;rj&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cal</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;calibration&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tfield</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tfield&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zaxis</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zaxis&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fname&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">filetype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">determine_map_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;wcs&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdrno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_wcs_map</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">filetype</span> <span class="o">==</span> <span class="s1">&#39;healpix&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdrno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_hpx_map</span><span class="p">()</span>
    
<div class="viewcode-block" id="mapObj.determine_map_type">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.determine_map_type">[docs]</a>
    <span class="k">def</span> <span class="nf">determine_map_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to determine if a fits file is a HEALPix file or a WCS (cartesian) file</span>

<span class="sd">        :return: Pixelisation scheme, `wcs` if a cartesian WCS-defined object or `healpix` if HEALPix pixelisation.</span>
<span class="sd">        :rtype: string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdul</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">hdul</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
                <span class="n">test</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;ORDERING&quot;</span><span class="p">]</span>
                <span class="k">return</span> <span class="s1">&#39;healpix&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;wcs&#39;</span></div>

        
<div class="viewcode-block" id="mapObj.read_wcs_map">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.read_wcs_map">[docs]</a>
    <span class="k">def</span> <span class="nf">read_wcs_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to read a fits file containing a map with WCS (cartesian) projection to memory</span>

<span class="sd">        :return: Map data, Map projection.</span>
<span class="sd">        :rtype: numpy.array, astropy.wcs.WCSObject</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">hdrno</span><span class="p">]</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tfield</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zaxis</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">zaxis</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">_</span><span class="p">]</span>
            <span class="n">proj</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">celestial</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">proj</span></div>

        
<div class="viewcode-block" id="mapObj.read_hpx_map">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.read_hpx_map">[docs]</a>
    <span class="k">def</span> <span class="nf">read_hpx_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to read a fits file containing a map with HEALPix projection to memory</span>

<span class="sd">        :return: Map data, Map projection.</span>
<span class="sd">        :rtype: numpy.array, astropy_healpix.HEALPix</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fname</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">hdrno</span><span class="p">]</span>
        <span class="n">coordsys</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;COORDSYS&quot;</span> <span class="ow">in</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COORDSYS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">coorddict</span><span class="p">:</span>
                <span class="n">coordsys</span> <span class="o">=</span> <span class="n">coorddict</span><span class="p">[</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COORDSYS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">coordsys</span> <span class="o">=</span> <span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;COORDSYS&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coordsys</span> <span class="o">=</span> <span class="s1">&#39;galactic&#39;</span>
        <span class="n">proj</span> <span class="o">=</span> <span class="n">HEALPix</span><span class="p">(</span><span class="n">nside</span><span class="o">=</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NSIDE&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;ORDERING&#39;</span><span class="p">],</span> <span class="n">frame</span><span class="o">=</span><span class="n">coordsys</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tfield</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tfield</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">proj</span></div>

    
<div class="viewcode-block" id="mapObj.reproject">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.reproject">[docs]</a>
    <span class="k">def</span> <span class="nf">reproject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shape_out</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;nearest_neighbour&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to reproject current map data into another projection specified by the keyword arguments supplied</span>

<span class="sd">        :param wcs: WCS object describing final projection. Defaults to None.</span>
<span class="sd">        :type wcs: astropy.wcs.WCSobject, optional</span>
<span class="sd">        :param shape_out: Desired final map shape supplied as a length-2 list. Defaults to None.</span>
<span class="sd">        :type shape_out: numpy.ndarray, optional)</span>
<span class="sd">        :param order: Interpolation scheme to use. Defaults to &#39;nearest_neighbour&#39;.</span>
<span class="sd">        :type order: str, optional</span>

<span class="sd">        :todo: Add support for HEALPix -&gt; HEALPix transformations</span>
<span class="sd">        :todo: Add support for WCS -&gt; HEALPix transformations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">)</span> <span class="o">==</span> <span class="n">WCS</span><span class="p">:</span>
            <span class="n">new_map</span><span class="p">,</span> <span class="n">new_footprint</span> <span class="o">=</span> <span class="n">reproject_interp</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">),</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">shape_out</span><span class="o">=</span><span class="n">shape_out</span><span class="p">)</span>
            <span class="n">new_map</span><span class="p">[</span><span class="n">new_footprint</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">new_map</span><span class="p">,</span> <span class="n">wcs</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">)</span> <span class="o">==</span> <span class="n">HEALPix</span><span class="p">:</span>
            <span class="n">new_map</span><span class="p">,</span> <span class="n">new_footprint</span> <span class="o">=</span> <span class="n">reproject_from_healpix</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">frame</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">shape_out</span><span class="o">=</span><span class="n">shape_out</span><span class="p">,</span> <span class="n">nested</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># new_map[new_footprint==0] = np.nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span> <span class="o">=</span> <span class="n">new_map</span><span class="p">,</span> <span class="n">wcs</span>
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="mapObj.smooth_to">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.smooth_to">[docs]</a>
    <span class="k">def</span> <span class="nf">smooth_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reso</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to smooth map to desired resolution based on arguments supplied</span>

<span class="sd">        Args:</span>
<span class="sd">            reso (astropy quantity, optional): Resolution of the final map. Need not be supplied if fwhm given, but priorotised if both given. Defaults to None.</span>

<span class="sd">        :param reso: Resolution of the final map. Need not be supplied if fwhm given, but priorotised if both given. Defaults to None.</span>
<span class="sd">        :type reso: astropy.units.Quantity</span>
<span class="sd">        :param fwhm: Full-width half maximum of a point source is the (desired) final map.</span>
<span class="sd">        :type fwhm: astropy.units.Quantity</span>

<span class="sd">        :raises ValueError: Map resolution lower than target resolution ({reso} &gt; {self.reso}). Please re-evaluate use of this map in this run.</span>
<span class="sd">        :raises ValueError: Operation not yet supported.</span>
<span class="sd">        </span>
<span class="sd">        :todo: Add support for smoothing HEALPix maps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_reso</span> <span class="o">=</span> <span class="n">reso</span>
        <span class="k">if</span> <span class="n">new_reso</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Map resolution lower than target resolution (</span><span class="si">{</span><span class="n">reso</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="si">}</span><span class="s2">). Please re-evaluate use of this map in this run.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_reso</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">)</span> <span class="o">==</span> <span class="n">WCS</span><span class="p">:</span>
                <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">new_reso</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mf">2.355</span>
                <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span>
                    <span class="n">x_stddev</span><span class="o">=</span><span class="n">dr</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="n">y_stddev</span><span class="o">=</span><span class="n">dr</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">new_map</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reso</span> <span class="o">=</span> <span class="n">new_map</span><span class="p">,</span> <span class="n">new_reso</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">)</span> <span class="o">==</span> <span class="n">HEALPix</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Operation not yet supported&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

    
<div class="viewcode-block" id="mapObj.convert_units">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.convert_units">[docs]</a>
    <span class="k">def</span> <span class="nf">convert_units</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_units</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pixel</span><span class="o">**</span><span class="mi">2</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Method to convert map to to desired units based on arguments supplied</span>

<span class="sd">        :param new_units: (_type_, optional): _description_. Defaults to u.Jy/(u.pixel**2).</span>

<span class="sd">        :raises ValueError: Unit not recognised as flux density units</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_units</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">:</span>
            <span class="c1"># first convert to Jy.sr</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">W</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)]:</span>
                <span class="n">map_int</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">))[:]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mK</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">uK</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">nK</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">==</span> <span class="s1">&#39;rj&#39;</span><span class="p">):</span>
                <span class="n">map_int</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">))[:]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mK</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">uK</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">nK</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span> <span class="o">==</span> <span class="s1">&#39;cmb&#39;</span><span class="p">):</span>
                <span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">Planck15</span>
                <span class="n">map_int</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">thermodynamic_temperature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">,</span> <span class="n">Planck15</span><span class="o">.</span><span class="n">Tcmb0</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span> <span class="n">get_astropy_unit</span><span class="p">(</span><span class="s1">&#39;MJy/sr&#39;</span><span class="p">)]):</span>
                <span class="n">map_int</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)[:]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">mJy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">beam</span><span class="p">]:</span>
                <span class="n">map_int</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">beam_angular_area</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_beam_area</span><span class="p">()))[:]</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pixel</span><span class="o">**</span><span class="mi">2</span><span class="p">)]:</span>
                <span class="n">pixel</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">pixel</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">map_int</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="p">)</span> <span class="o">/</span> <span class="n">pixel</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unit </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s1"> not recognised as flux density units&#39;</span><span class="p">)</span>
            <span class="c1"># convert to final units</span>
            <span class="c1"># first convert to Jy.sr</span>
            <span class="k">if</span> <span class="n">new_units</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">W</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">)]:</span>
                <span class="n">map_final</span> <span class="o">=</span> <span class="n">map_int</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">new_units</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral_density</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">))[:]</span>
            <span class="k">elif</span> <span class="n">new_units</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">]:</span>
                <span class="n">map_final</span> <span class="o">=</span> <span class="n">map_int</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">new_units</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">brightness_temperature</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">))[:]</span>
            <span class="k">elif</span> <span class="n">new_units</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">sr</span><span class="p">]:</span>
                <span class="n">map_final</span> <span class="o">=</span> <span class="n">map_int</span><span class="p">[:]</span>
            <span class="k">elif</span> <span class="n">new_units</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">beam</span><span class="p">]:</span>
                <span class="n">map_final</span> <span class="o">=</span> <span class="n">map_int</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">new_units</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">beam_angular_area</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_beam_area</span><span class="p">()))[:]</span>
            <span class="k">elif</span> <span class="n">new_units</span> <span class="ow">in</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pixel</span><span class="o">**</span><span class="mi">2</span><span class="p">)]:</span>
                <span class="n">pixel</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">cdelt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">pixel</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">map_final</span> <span class="o">=</span> <span class="p">(</span><span class="n">map_int</span> <span class="o">*</span> <span class="n">pixel</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Jy</span><span class="o">/</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">pixel</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unit </span><span class="si">{</span><span class="n">new_units</span><span class="si">}</span><span class="s1"> not recognised as flux density units&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="n">map_final</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">map_final</span><span class="o">.</span><span class="n">unit</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="mapObj.get_pixel_coords">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.get_pixel_coords">[docs]</a>
    <span class="k">def</span> <span class="nf">get_pixel_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to return an array of center coordinates for each pixel</span>

<span class="sd">        :return: Array of SkyCoord objects representing sky coordinates of the center of each map pixel.</span>
<span class="sd">        :rtype: numpy.ndarray of astropy.coords.SkyCoord</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Xp</span><span class="p">,</span><span class="n">Yp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">sc</span> <span class="o">=</span> <span class="n">pixel_to_skycoord</span><span class="p">(</span><span class="n">Xp</span><span class="p">,</span> <span class="n">Yp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sc</span></div>

    
<div class="viewcode-block" id="mapObj.get_beam_area">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.get_beam_area">[docs]</a>
    <span class="k">def</span> <span class="nf">get_beam_area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to return beam area</span>

<span class="sd">        :return: Beam area.</span>
<span class="sd">        :rtype: astropy.unit.Quantity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bwid</span><span class="o">/</span><span class="mf">2.355</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span></div>

    
<div class="viewcode-block" id="mapObj.meta_to_hdr">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.meta_to_hdr">[docs]</a>
    <span class="k">def</span> <span class="nf">meta_to_hdr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unit</span> <span class="o">==</span> <span class="n">u</span><span class="o">.</span><span class="n">K</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">include</span> <span class="o">=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s1">&#39;Resolution : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Beamwidth : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bwid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Frequency : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;Units : </span><span class="si">{</span><span class="n">unit</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s1">&#39;calUncertainty : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uncert_cal</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">include</span></div>

    
<div class="viewcode-block" id="mapObj.save_out">
<a class="viewcode-back" href="../../../mapext.core.html#mapext.core.mapClass.mapObj.save_out">[docs]</a>
    <span class="k">def</span> <span class="nf">save_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to save out the current state of a map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">to_header</span><span class="p">())</span>
        <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">(</span><span class="n">hdu</span><span class="p">)</span>
        
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Processed with MAPEXT </span><span class="si">{</span><span class="n">_version</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_to_hdr</span><span class="p">():</span>
            <span class="n">hdul</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;COMMENT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span>
            
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outfilename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outfilename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reso</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">outfilename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;File already exists - not overwritten&#39;</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">hdul</span>
        <span class="k">return</span></div>
</div>

        
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, tjrennie.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>